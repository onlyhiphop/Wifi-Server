<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="apple-touch-icon" sizes="76x76" href="../static/assets/img/apple-icon.png" />
	<link rel="icon" type="image/png" href="../static/assets/img/favicon.png" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>离线数据分析</title>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />

	<link href="../static/layui2.5.6/css/layui.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap core CSS     -->
    <link href="../static/assets/css/bootstrap.min.css" rel="stylesheet" />

    <!--  Material Dashboard CSS    -->
    <link href="../static/assets/css/material-dashboard.css" rel="stylesheet"/>

    <!--  CSS for Demo Purpose, don't include it in your project     -->
    <link href="../static/assets/css/demo.css" rel="stylesheet" />

    <!--     Fonts and icons     -->
    <link href="../static/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href='../static/material-icon/icon.css' rel='stylesheet' type='text/css'>

	<!-- 引入layui -->
	<script src="../static/layui2.5.6/layui.js"></script>
	

	<style>
		.card .card-header.card-chart{
			padding: 0;
			min-height: 300px;
		}
		.card-stats .card-content{
			text-align: left;
    		padding-top: 10px;
		}
		.formSearchClass{
			padding-right: 15px;
    		padding-left: 15px;
		}
	</style>
</head>

<body>

	<div class="wrapper">

	    <div class="sidebar" data-color="purple" data-image="../static/assets/img/sidebar-1.jpg">
			<!--
		        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

		        Tip 2: you can also add an image using data-image tag
		    -->

			<div class="logo">
				
				<a href="http://www.Onlyhiphop.com" class="simple-text">
					Onlyhiphop
				</a>
			</div>

	    	<div class="sidebar-wrapper">
	            <ul class="nav">
	                <li class="active">
	                    <a href="/index">
	                        <i class="material-icons">equalizer</i>
	                        <p>离线数据处理</p>
	                    </a>
	                </li>
	                <li>
	                    <a href="/realTime">
	                        <i class="material-icons">timeline</i>
	                        <p>实时数据处理</p>
	                    </a>
	                </li>
	                <li>
	                    <a href="table.html">
	                        <i class="material-icons">settings_system_daydream</i>
	                        <p>系统监控</p>
	                    </a>
	                </li>
	                <li>
	                    <a href="typography.html">
	                        <i class="material-icons">settings_input_antenna</i>
	                        <p>探针设置</p>
	                    </a>
	                </li>
					<li class="active-pro">
	                    <a href="upgrade.html">
	                        <i class="material-icons">unarchive</i>
	                        <p>Upgrade to PRO</p>
	                    </a>
	                </li>
	            </ul>
	    	</div>
	    </div>

		<div class="main-panel">

			<nav class="navbar navbar-transparent navbar-absolute">
				<div class="container-fluid">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle" data-toggle="collapse">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="#">离线数据分析展示</a>
					</div>
				</div>
			</nav>


			<div class="content">
				<div class="container-fluid">
					<!-- 待的地方次数和时间分析 -->
					<div class="row">
						<div class="col-md-12">
	                        <div class="card">
	                            <div class="card-header" data-background-color="purple">
									<span><h4 class="title" style="display: inline-block;">学生校园内行为轨迹</h4></span>
	                            </div>
								<div class="card-content">
									<div class="row">
										<div class="formSearchClass">
											<form id="countTimeForm" class="navbar-form navbar-left" style="margin-top: -20px;margin-bottom: 0px;" role="search">
												<div class="form-group  is-empty">
													学号：
													<input name="sid" type="text" class="form-control required" placeholder="请输入学生学号...">
													<span class="material-input"></span>
												</div>
												<div class="form-group  is-empty">
													日期：
													<input type="text" readonly name="date" id="date1" lay-verify="date1" autocomplete="off" class="form-control layui-input" placeholder="请输入日期...">
													<span class="material-input"></span>
												</div>
												<button type="button" onclick="formSubmitFunc(this);" data-form="countTimeForm" class="btn btn-white btn-round btn-just-icon">
													<i class="material-icons">search</i><div class="ripple-container"></div>
												</button>
											</form>
										</div>
									</div>

									<div class="row">

										<!-- 访问时间 -->
										<div class="col-lg-6 col-md-12">
											<div class="card card-nav-tabs">
												<div class="card-header" data-background-color="blue">
													<div class="nav-tabs-navigation">
														<div class="nav-tabs-wrapper">
															<ul class="nav nav-tabs" data-tabs="tabs">
																<li class="active">
																	<a href="#timePie" data-toggle="tab">
																		<i class="material-icons">pie_chart</i>
																		饼图
																	<div class="ripple-container"></div></a>
																</li>
																<li class="">
																	<a href="#timeBar" data-toggle="tab">
																		<i class="material-icons">insert_chart</i>
																		柱状图
																	<div class="ripple-container"></div></a>
																</li>
																<li class="">
																	<a href="#timeCompare" data-toggle="tab">
																		<i class="material-icons">code</i>
																		对比图
																	<div class="ripple-container"></div></a>
																</li>
															</ul>
														</div>
													</div>
												</div>
				
												<div class="card-content">
													<div class="tab-content">
														<div class="tab-pane active" id="timePie">
															<div class="col-md-12">
																<div class="card">
																	<div class="card-header card-chart" data-background-color="white">
																		<div class="ct-chart" id="timePieChartDiv"></div>
																	</div>
																	<div class="card-content">
																		<h4 class="title">校园内各地点访问时间</h4>
																	</div>
																</div>
															</div>
														</div>
														<div class="tab-pane" id="timeBar">
															<div class="col-md-12">
																<div class="card">
																	<div class="card-header card-chart" data-background-color="white">
																		<div class="ct-chart" id="timeBarChartDiv"></div>
																	</div>
																	<div class="card-content">
																		<h4 class="title">校园内各地点访问时间</h4>
																	</div>
																</div>
															</div>
														</div>
														<div class="tab-pane" id="timeCompare">
															<div class="col-md-12">
																<div class="card">
																	<div class="card-header card-chart" data-background-color="white">
																		<div class="ct-chart" id="timeTowBarChartDiv"></div>
																	</div>
																	<div class="card-content">
																		<h4 class="title">校园内各地点访问时间</h4>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>

										<!-- 访问次数 -->
										<div class="col-lg-6 col-md-12">
											<div class="card card-nav-tabs">
												<div class="card-header" data-background-color="blue">
													<div class="nav-tabs-navigation">
														<div class="nav-tabs-wrapper">
															<ul class="nav nav-tabs" data-tabs="tabs">
																<li class="active">
																	<a href="#countBar" data-toggle="tab">
																		<i class="material-icons">insert_chart</i>
																		柱状图
																	<div class="ripple-container"></div></a>
																</li>
																<li class="">
																	<a href="#countPie" data-toggle="tab">
																		<i class="material-icons">pie_chart</i>
																		饼图
																	<div class="ripple-container"></div></a>
																</li>
																<li class="">
																	<a href="#countCompare" data-toggle="tab">
																		<i class="material-icons">code</i>
																		对比图
																	<div class="ripple-container"></div></a>
																</li>
															</ul>
														</div>
													</div>
												</div>
				
												<div class="card-content">
													<div class="tab-content">
														<div class="tab-pane active" id="countBar">
															<div class="col-md-12">
																<div class="card">
																	<div class="card-header card-chart" data-background-color="white">
																		<div class="ct-chart" id="countBarChartDiv"></div>
																	</div>
																	<div class="card-content">
																		<h4 class="title">校园内各地点访问次数</h4>
																	</div>
																</div>
															</div>
														</div>
														<div class="tab-pane" id="countPie">
															<div class="col-md-12">
																<div class="card">
																	<div class="card-header card-chart" data-background-color="white">
																		<div class="ct-chart" id="countPieChartDiv"></div>
																	</div>
																	<div class="card-content">
																		<h4 class="title">校园内各地点访问次数</h4>
																	</div>
																</div>
															</div>
														</div>
														<div class="tab-pane" id="countCompare">
															<div class="col-md-12">
																<div class="card">
																	<div class="card-header card-chart" data-background-color="white">
																		<div class="ct-chart" id="countTowBarChartDiv"></div>
																	</div>
																	<div class="card-content">
																		<h4 class="title">校园内各地点访问次数</h4>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
				
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- 消费能力分析 -->
					<div class="row">
						<div class="col-md-12">
	                        <div class="card">
	                            <div class="card-header" data-background-color="purple">
	                                <h4 class="title">消费能力预测</h4>
	                            </div>
								<div class="card-content">
									<div class="row">
										<div class="formSearchClass">
											<form id="consumeForm" class="navbar-form navbar-left" style="margin-top: -20px;margin-bottom: 0px;" role="search">
												<div class="form-group  is-empty">
													学号：
													<input name="sid" type="text" class="form-control required" placeholder="请输入学生学号...">
													<span class="material-input"></span>
												</div>
												<button type="button" data-form="consumeForm" onclick="formSubmitFunc(this);" class="btn btn-white btn-round btn-just-icon">
													<i class="material-icons">search</i><div class="ripple-container"></div>
												</button>
											</form>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6">
											<div class="card">
												<div class="card-header card-chart" data-background-color="white">
													<div class="ct-chart" id="consumeChartDiv"></div>
												</div>
												<div class="card-content">
													<h4 class="title">消费能力分析</h4>
												</div>
											</div>
										</div>
				
										<div class="col-lg-3 col-md-6 col-sm-6">
											<div class="card card-stats">
												<div class="card-content">
													<p class="category">超越同校</p>
													<h3 class="title all-point"><span>0</span><small>%</small></h3>
												</div>
											</div>
										</div>

										<div class="col-lg-3 col-md-6 col-sm-6">
											<div class="card card-stats">
												<div class="card-content">
													<p class="category">超越同系</p>
													<h3 class="title faculty-point"><span>0</span><small>%</small></h3>
												</div>
											</div>
										</div>

										<div class="col-lg-3 col-md-6 col-sm-6">
											<div class="card card-stats">
												<div class="card-content">
													<p class="category">超越同班</p>
													<h3 class="title clas-point"><span>0</span><small>%</small></h3>
												</div>
											</div>
										</div>

									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- 手机夜间使用情况 -->
					<div class="row">
						<div class="col-md-12">
	                        <div class="card">
	                            <div class="card-header" data-background-color="purple">
	                                <h4 class="title">手机夜间使用情况</h4>
	                            </div>
								<div class="card-content">
									<div class="row">
										<div class="formSearchClass">
											<form id="dsNightForm" class="navbar-form navbar-left" style="margin-top: -20px;margin-bottom: 0px;" role="search">
												<div class="form-group  is-empty">
													学号：
													<input name="sid" type="text" class="form-control required" placeholder="请输入学生学号...">
													<span class="material-input"></span>
												</div>
												<div class="form-group  is-empty">
													年：
													<input type="text" readonly name="year" id="date2" lay-verify="date2" class="form-control" placeholder="请输入年份...">
													<span class="material-input"></span>
												</div>
												<div class="form-group  is-empty">
													月：
													<input type="text" readonly name="month" id="date21" lay-verify="date21" class="form-control" placeholder="请输入年份...">
													<span class="material-input"></span>
												</div>
												<button type="button" data-form="dsNightForm" onclick="formSubmitFunc(this);" class="btn btn-white btn-round btn-just-icon">
													<i class="material-icons">search</i><div class="ripple-container"></div>
												</button>
											</form>
										</div>
									</div>
									<div class="row">
										<div class="col-md-12">
											<div class="card">
												<div class="card-header card-chart" style = "min-height: 400px;" data-background-color="white">
													<div class="ct-chart" id="dsNightChartDiv"></div>
												</div>
												<div class="card-content">
													<h4 class="title">夜间手机使用情况（23:00 ~ 5:00）</h4>
												</div>
											</div>
										</div>

									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- 一年各月数据对比 -->
					<div class="row">
						<div class="col-md-12">
	                        <div class="card">
	                            <div class="card-header" data-background-color="purple">
	                                <h4 class="title">各月数据对比</h4>
	                            </div>
								<div class="card-content">
									<div class="row">
										<div class="formSearchClass">
											<form id="allMonthForm" class="navbar-form navbar-left" style="margin-top: -20px;margin-bottom: 0px;" role="search">
												<div class="form-group  is-empty">
													学号：
													<input name="sid" type="text" class="form-control" placeholder="请输入学生学号...">
													<span class="material-input"></span>
												</div>
												<div class="form-group  is-empty">
													年份：
													<input type="text" readonly name="year" id="date3" lay-verify="date3" class="form-control" placeholder="请输入年份...">
													<span class="material-input"></span>
												</div>
												<button type="button" data-form="allMonthForm" onclick="formSubmitFunc(this);" class="btn btn-white btn-round btn-just-icon">
													<i class="material-icons">search</i><div class="ripple-container"></div>
												</button>
											</form>
										</div>
									</div>
									<div class="row">
										<div class="col-md-12">
											<div class="card">
												<div class="card-header card-chart" style="min-height: 550px;" data-background-color="white">
													<div class="ct-chart" id="allMonthChartDiv"></div>
												</div>
												<div class="card-content">
													<h4 class="title">xxxx年的数据对比</h4>
												</div>
											</div>
										</div>

									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>

	    
	</div>

</body>

	<!--   Core JS Files   -->
	<script src="../static/assets/js/jquery-3.1.0.min.js" type="text/javascript"></script>
	<script src="../static/assets/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../static/assets/js/material.min.js" type="text/javascript"></script>

	<!--  Notifications Plugin    -->
	<script src="../static/assets/js/bootstrap-notify.js"></script>


	<!-- Material Dashboard javascript methods -->
	<script src="../static/assets/js/material-dashboard.js"></script>

	<!-- 画图! -->
	<script src="../static/echarts/echarts.min.js"></script>
	<script src="../static/myJs/chart.js"></script>

	<script type="text/javascript">

		var pervDraw = function(e, width, height){
			var chartDivElem = $("#" + e);
			if(!width){
				chartDivElem.width(chartDivElem.parent().width());
			}else{
				chartDivElem.width(width)
			}
			if(!height){
				chartDivElem.height(chartDivElem.parent().height());

			}else{
				chartDivElem.height(height)
			}
			var paramDraw = document.getElementById(e);
			return paramDraw;
		}

		var formSubmitFunc = function(e){

			//学号不能为空
			var sidValue = $(e).parent('form').find('input.required');
			var sidVal = '';
			if(sidValue){
				sidVal = sidValue.val();
			}

			if (!sidVal){
				layer.msg('学号不能为空', {icon: 2});
				return;
			}

			var formId = $(e).data('form');
			var url = "";
			var data = {};
			if(formId == "countTimeForm"){   //行为轨迹form
				url = "/api/behavior";
				data = $('#countTimeForm').serialize();

				// 时间图
				var width = $('#timePieChartDiv').parent().width();
				var height = $('#timePieChartDiv').parent().height();

				var pieElement = pervDraw("timePieChartDiv");
				var barElement = pervDraw("timeBarChartDiv", width, height);
				var twoBarElement = pervDraw("timeTowBarChartDiv", width, height);

				//次数图
				var pieElement2 = pervDraw("countPieChartDiv", width, height);
				var barElement2 = pervDraw("countBarChartDiv", width, height);
				var twoBarElement2 = pervDraw('countTowBarChartDiv', width, height);

				$.ajax({
					url: url
					,type: 'post'
					,data: data
					,dataType: 'json'
					,success: function(res){
						if(res.code != '200'){
							layer.msg("服务器错误...", {icon: 2});
							return;
						}
						var data = res.data;

						var countAverageArr = data.countAverage;
						var timeAverageArr = data.timeAverage;

						var countArr = data.count;
						var countXArr = [];
						var countYArr = [];
						var countPieData = []
						for(var i = 0; i < countArr.length; i++){
							var item = countArr[i];
							var comeCount = item.comeCount;
							var placeName = item.wifiInfo.placeName;
							countXArr.push(placeName);
							countYArr.push(comeCount);
							countPieData.push({name: placeName, value: comeCount})
						}

						var timeArr = data.time;
						var timeXArr = [];
						var timeYArr = [];
						var timePieData = [];
						for(var i = 0; i < timeArr.length; i++){
							var item = timeArr[i];
							var stayDuration = item.stayDuration;
							var placeName = item.wifiInfo.placeName;
							timeXArr.push(placeName);
							timeYArr.push(stayDuration);
							timePieData.push({name: placeName, value: stayDuration})
						}

						var twoData = []
						for(var i = 0; i < countAverageArr.length;i ++){
							var item = countAverageArr[i];
							var placeName1 = item.wifiInfo.placeName;
							var countAverage = item.average;
							twoData.push({name: placeName1, value: countAverage})
						}
						var twoTimeData = []
						for(var i = 0; i < timeAverageArr.length;i ++){
							var item = timeAverageArr[i];
							var placeName1 = item.wifiInfo.placeName;
							var timeAverage = item.average;
							twoTimeData.push({name: placeName1, value: timeAverage})
						}

						var twoData2 = []
						for(var i = 0; i < twoData.length; i++){
							var item1 = twoData[i];
							var flag = false;
							for(var j = 0; j < countPieData.length; j++){
								var item2 = countPieData[j];
								if(item2.name == item1.name){
									flag = true;
									twoData2.push({name: item1.name, "该生": item2.value, "班级平均值": item1.value})
									break;
								}
							}
							if(flag == false){
								twoData2.push({name: item1.name, "该生": 0, "班级平均值": item1.value})
							}
						}

						var towTimeData2 = []
						for(var i = 0; i < twoTimeData.length; i++){
							var item1 = twoTimeData[i];
							var flag = false;
							for(var j = 0; j < timePieData.length; j++){
								var item2 = timePieData[j];
								if(item2.name == item1.name){
									flag = true;
									towTimeData2.push({name: item1.name, "该生": item2.value, "班级平均值": item1.value})
									break;
								}
							}
							if(flag == false){
								towTimeData2.push({name: item1.name, "该生": 0, "班级平均值": item1.value})
							}
						}

						console.log(twoData2);
						console.log(towTimeData2);
						//时间图
						drawChart.initPie(pieElement, timePieData, '时间统计');
						drawChart.initBar(barElement, [countXArr, countYArr], "时间/分");
						drawChart.initTowBar(twoBarElement, twoData2,2);

						//次数图
						drawChart.initPie(pieElement2,countPieData, '次数统计');
						drawChart.initBar(barElement2, [timeXArr, timeYArr], "次数");
						drawChart.initTowBar(twoBarElement2, towTimeData2,2);
					}
				})


			}else if(formId == 'consumeForm'){  //消费水平的form
				url = "/api/consume";
				data = $('#consumeForm').serialize();
				$.ajax({
					url: url
					,type: 'post'
					,dataType: 'json'
					,data: data
					,success: function(res){
						if(res.code != '200'){
							layer.msg("服务器错误...", {icon: 2})
							return;
						}
						var data = res.data.chart;
						var classPoint = res.data.classPoint;
						var facultyPoint = res.data.facultyPoint;
						var allPoint = res.data.allPoint;
						$('h3.clas-point span').text(classPoint);
						$('h3.faculty-point span').text(facultyPoint);
						$('h3.all-point span').text(allPoint);

						var conSumeBar = pervDraw('consumeChartDiv');
						drawChart.initTowBar(conSumeBar, data, 4);

					}
				})



			}else if(formId == 'dsNightForm'){  //手机夜间使用情况form
				var yearEle = $('#dsNightForm').find('input[name=year]').val();
				var monthEle = $('#dsNightForm').find('input[name=month]').val();
				if(monthEle && !yearEle){
					layer.msg("缺少年份", {icon: 2});
					return;
				}
				url = "/api/dsNight";
				data = $('#dsNightForm').serialize();
				$.ajax({
					url: url
					,type: 'post'
					,dataType: 'json'
					,data: data
					,success: function(res){
						if(res.code != '200'){
							layer.msg("服务器错误...", {icon: 2})
							return;
						}
						var data = res.data;
						var dsLine = pervDraw('dsNightChartDiv');
						drawChart.initLine(dsLine,data);
					}
				})



			}else if(formId == 'allMonthForm'){  //各月数据对比
				url = "/api/allMonth";
				var year = $('#allMonthForm').find('input[name=year]').val();
				if(!year){
					layer.msg("缺少年份", {icon: 2});
					return;
				}
				$.ajax({
					url: url
					,type: 'post'
					,dataType: 'json'
					,data: data
					,success: function(res){
						if(res.code != '200'){
							layer.msg("服务器错误...", {icon: 2})
							return;
						}
						var data = res.data;
						var dsLine = pervDraw('allMonthChartDiv');
						drawChart.initTowLine(dsLine,data);
					}
				});

			}




		}

    	$(document).ready(function(){

			// Javascript method's body can be found in assets/js/demos.js
        	// demo.initDashboardPageCharts();

		});
	</script>
	<script>
		layui.use(['laydate', 'layer'], function() {
			var laydate = layui.laydate
			,layer = layui.layer;

			//行为轨迹
			laydate.render({
				elem: '#date1'
				,type: 'month'       //选择年月
				,format: 'yyyy-MM'
				,theme: '#ab47bc'   //主题
				,value: '2020-02'        //初始值
				,done: function(e) { //选中后的回调函数

				}
			});

			//手机使用情况
			laydate.render({
				elem: '#date2'
				,type: 'year'       //选择年月
				,format: 'yyyy'
				,theme: '#ab47bc'   //主题
				,value: ''        //初始值
				,done: function(e) { //选中后的回调函数

				}
			});
			laydate.render({
				elem: '#date21'
				,type: 'month'       //选择年月
				,format: 'MM'
				,theme: '#ab47bc'   //主题
				,value: ''        //初始值
				,done: function(e) { //选中后的回调函数

				}
			});

			//各月数据对比
			laydate.render({
				elem: '#date3'
				,type: 'year'       //选择年月
				,format: 'yyyy'
				,theme: '#ab47bc'   //主题
				,value: ''        //初始值
				,done: function(e) { //选中后的回调函数

				}
			});

		})
	</script>
</html>
